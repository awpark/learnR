---
title: "Data visualization"
author: "Andrew W. Park"
output:
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(learnr)
```

## Learning outcomes

1. to

2. be

3. done

## Introduction

This is the first in a series of modules that constitute *Introduction to Scientific Programming*, taught through the IDEAS PhD program at the University of Georgia's Odum School of Ecology in conjunction with the Center for the Ecology of Infectious Diseases. This module introduces the principles and practice of data visualization with special emphasis on analysis of infectious disease data. Programming is performed in R. Recommended reading for this module is the book *R for Data Science* by Hadley Wickham and Garret Grolemund (O'Reilly Media, 2017).

Specifically, this module seeks to introduce the student to basic tasks and operations required to visualize data in R using the packages `ggplot2`. *Data visualization* is a key component of *exploratory data analysis*. `ggplot2` implements the idea that there is a "grammar of graphics" -- that is an organizational scheme based on the semantic relationships among different graphical elements. Data visualization theory, practice, and exploratory data analysis are not covered systematically, but rather by example, with the expectation that students will develop further skills by extending the provided examples.


## Case study

As a running example in this module, we will study a data set on the spread of Middle East Respiratory Syndrome Corona Virus (MERS-CoV) compiled and originally made available by Andrew Rambaut on his Github site (https://github.com/rambaut/MERS-Cases/blob/gh-pages/data/cases.csv). MERS-CoV is a positive-sense single-stranded Betacoronavirus. Its closest relatives are the SARS coronavirus, common-cold coronavirus, and other human betacoronaviruses. MERS-CoV first emerged in Saudi Arabia in 2012. It causes a severe respiratory illness. Transmission to humans may be direct (person-to-person), particularly in hospitals, or from contact with infected animals. Exposure to camels is associated with many cases, although bats, particularly the Egyptian Tomb bat (*Taphozous perforatus*), are suspected to be the maintenance reservoir. The case fatality rate is around 40%.

## Getting the data into R

To load the MERS data into an R session, we will first load a key package `tidyverse`. This actually loads a suite of packages including `ggplot2` and `readr`, with the latter providing useful functions for reading data into R. We'll additionally load a package called `magrittr` which allows us to write R code as workflows passing through 'pipes'. If interested, you can read more about pipes here: https://r4ds.had.co.nz/pipes.html

```{r libLoad, exercise=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)
```

By loading `tidyverse` we now have the function `read_csv` available to us. We will use this function to read in the file "cases.csv", which we will assign to the variable "mers". 


```{r readData-setup, echo=FALSE, message=F, warning=FALSE}
library(tidyverse)
library(magrittr)
```


```{r readData, exercise=FALSE, message=FALSE, warning=FALSE}
mers <- read_csv("https://raw.githubusercontent.com/awpark/learnR/master/ldPopClim.csv")
```



## Formatting some dates

We can inspect the data using the base R function `head`, which displays the first few rows of data. Try doing this for the data frame "mers" that we have just created. If you're ever unsure how to complete a coding challenge in this module, you can click the "solution" button.

```{r inspectData1-setup, echo=FALSE, message=F, warning=FALSE}
library(tidyverse)
library(magrittr)
mers <- read_csv("https://raw.githubusercontent.com/awpark/learnR/master/ldPopClim.csv")
```


```{r inspectData1, exercise=TRUE, exercise.eval=FALSE, message=FALSE, warning=FALSE}

```

```{r inspectData1-solution}
head(mers)
```



We can additionally find out what kind of data are stored in a particular column of a data frame using the base function `class`. Columns are referred to using the `$` sign. For example, the column "onset" in the "mers" data frame is referred to by `mers$onset`. What type of data are stored in the column "onset". 

```{r inspectData2-setup, echo=FALSE, message=F, warning=FALSE}
library(tidyverse)
library(magrittr)
mers <- read_csv("https://raw.githubusercontent.com/awpark/learnR/master/cases.csv")
```


```{r inspectData2, exercise=TRUE, exercise.eval=FALSE, message=FALSE, warning=FALSE}

```

```{r inspectData2-solution}
class(mers$onset)
```

We see that the data in this column represent dates but are formatted as a data type called factor. It is common that R defaults to assuming factor. The other date column ("hospitalized") is also formatted as factor. These dates can be reformatted using the `lubridate` package. Next, we'll use this package to create a new version of the "onset" and "hospitalized" columns (called "onset2" and "hospitalized2") using the `Date` class. 

```{r}
library(lubridate)
# here the %<>% symbol is a 2-way pipe: (i) we pass mers from L to R and use the function mutate to create two new columns
# (ii) we pass the result back (from R to L) i.e. we call the new data frame 'mers' which is now the original plus these two
# new columns. The 'ymd' function turns text like "2015-02-14" into data meaning 14th Feb 2015.
mers %<>% mutate(onset2=ymd(onset), hospitalized2=ymd(hospitalized))
class(mers$onset2)
```


We may also find it useful to have a simple numerical value for the days elapsed since the start of the epidemic.  We use the following cod, which identifies the earliest onset date then measures time since that date.

```{r}
# R needs to be told that any NA values are not included in search for minimum otherwise NA is the minimum!
# start with mers; pull the onset2 column; find the min; store in 'day0'
day0 <- mers %>% pull(onset2) %>% min(na.rm=T)
# create a new column 'epi.day' which is number of days since "case 0". We use 'as.numeric' so this is just stored as a number.
mers %<>% mutate(epi.day=as.numeric(onset2 - day0))
```



## Making a plot


We can explore some of the MERS data using the function `ggplot`. One plot we might wish to produce is the *epidemic curve* which is basically a bar plot.  An empty plot can be produced using the command `ggplot(data=mers)`. The epidemic curve is then produced by adding a bar plot using the geom function `geom_bar`. The last line of our code adds some labels. Ryn the code to check it works.

```{r epiCurve-setup, echo=FALSE, message=F, warning=FALSE}
library(tidyverse)
library(magrittr)
library(lubridate)
load("getMers1.Rda")
```


```{r epiCurve, exercise=FALSE, message=FALSE, warning=FALSE}
ggplot(data=mers) + 
  geom_bar(mapping=aes(x=epi.day)) +
  labs(x='Epidemic day', y='Case count', title='Global count of MERS cases by date of symptom onset',
       caption="Data from: https://github.com/rambaut/MERS-Cases/blob/gh-pages/data/cases.csv")
```

<!-- **Exercise. To produce this plot, type all the commands up to this point *exactly* as they appear. Particularly, note that as we "build" the plot in the last code snippet, we end each line with the addition syhmbol "+". What happens if we don't use this convention?** -->

<!-- Of course, all these cases are distributed among a number of different countries. We can modify the plot to show this using the using the aesthetic `fill`. -->

<!-- ```{r} -->
<!-- ggplot(data=mers) +  -->
<!--   geom_bar(mapping=aes(x=epi.day, fill=country)) + -->
<!--   labs(x='Epidemic day', y='Case count', title='Global count of MERS cases by date of symptom onset', -->
<!--        caption="Data from: https://github.com/rambaut/MERS-Cases/blob/gh-pages/data/cases.csv") -->
<!-- ``` -->

<!-- In this example, we've shown how to make a basic bar plot with `ggplot` and the geom function `geom_bar`. Our mapping of data objects to plot objects was performed using `aes` and we used the `fill` aesthetic to examing the distribution of cases among countries. There are lots of variations on the bar plot that we can examine. For instance, we can modify the `position`, which is another argument to `geom_bar`. -->

<!-- **Exercise. Modify the epidemic curve using the argument `position="fill"`. What does this plot show?** -->

<!-- **Exercise. Another way to modify a bar plot is to change the coordinates. This can be done by "adding" `coord_flip()` and `coord_polar()` to the plot. What does this plot show?** -->



